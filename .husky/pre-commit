#!/bin/sh

# Claude Code Boilerplate Pre-Commit Checks
# Complements MCP hooks by catching issues at Git level

echo "üîç Running pre-commit checks..."

# 1. PRP Level 1 Validation (if active PRP exists and runner exists)
if [ -d "PRPs/active" ] && [ "$(ls -A PRPs/active 2>/dev/null)" ] && [ -f "PRPs/scripts/prp-runner.ts" ]; then
  echo "üìã Checking PRP compliance..."
  npm run prp:validate:quick 2>/dev/null || {
    echo "‚ùå PRP validation failed"
    echo "üí° Run: /prp-execute --level 1 --fix"
    exit 1
  }
fi

# 2. Quick Design System Check (faster than full /vd)
echo "üé® Quick design check..."
npm run design:check:staged 2>/dev/null || {
  echo "‚ùå Design violations in staged files"
  echo "üí° Run: /vd --fix"
  exit 1
}

# 3. TypeScript on staged files only
echo "üìò TypeScript check..."
node scripts/typecheck-staged.js || {
  echo "‚ùå TypeScript errors in staged files"
  echo "üí° Fix type errors before committing"
  exit 1
}

# 4. Quick unit tests for changed components
echo "üß™ Running quick tests..."
npm run test:quick:staged 2>/dev/null || {
  echo "‚ùå Tests failing"
  echo "üí° Ensure tests pass before committing"
  exit 1
}

# 5. Check for console.logs in production code
echo "üîç Checking for debug code..."
CONSOLE_CHECK=$(git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -l 'console\.\(log\|error\|warn\)' 2>/dev/null | grep -v -E '(test|spec|\.d\.ts)' || true)
if [ -n "$CONSOLE_CHECK" ]; then
  echo "‚ö†Ô∏è  console.log found in production code:"
  echo "$CONSOLE_CHECK"
  echo "üí° Remove console statements or use proper logging"
  # Warning only, don't block
fi

echo "‚úÖ Pre-commit checks passed!"
